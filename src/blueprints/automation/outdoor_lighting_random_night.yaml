blueprint:
  name: Outdoor Lights â€“ Independent Random Activity (Label Safe)
  description: Randomly toggles individual outdoor lights overnight
  domain: automation

  input:
    lights:
      name: Outdoor Lights
      description: Select labels, areas, or lights
      selector:
        target: {}

    random_start:
      name: Random Start Time
      default: "23:00:00"
      selector:
        time: {}

    random_end:
      name: Random End Time
      default: "04:30:00"
      selector:
        time: {}

    min_events:
      name: Minimum Events
      default: 2
      selector:
        number:
          min: 0
          max: 20
          step: 1

    max_events:
      name: Maximum Events
      default: 8
      selector:
        number:
          min: 1
          max: 30
          step: 1

    min_delay:
      name: Minimum Delay (minutes)
      default: 10
      selector:
        number:
          min: 1
          max: 180
          step: 5

    max_delay:
      name: Maximum Delay (minutes)
      default: 60
      selector:
        number:
          min: 5
          max: 240
          step: 5

trigger:
  - platform: sun
    event: sunset
    id: sunset

  - platform: time
    at: !input random_start
    id: random_start

  - platform: time
    at: !input random_end
    id: random_end

  - platform: sun
    event: sunrise
    id: sunrise

variables:
  lights_list: "{{ expand(lights.entity_id | default([], true)) | selectattr('domain','eq','light') | map(attribute='entity_id') | list }}"
  event_count: "{{ range(min_events | int, max_events | int + 1) | random }}"

action:
  - choose:
      - conditions:
          - condition: trigger
            id: sunset
        sequence:
          - service: light.turn_on
            target: !input lights

      - conditions:
          - condition: trigger
            id: random_start
        sequence:
          - repeat:
              count: "{{ event_count }}"
              sequence:
                - delay:
                    minutes: "{{ range(min_delay | int, max_delay | int + 1) | random }}"
                - condition: sun
                  before: sunrise
                - service: light.toggle
                  target:
                    entity_id: "{{ lights_list | random }}"

      - conditions:
          - condition: trigger
            id: random_end
        sequence:
          - service: light.turn_on
            target: !input lights

      - conditions:
          - condition: trigger
            id: sunrise
        sequence:
          - service: light.turn_off
            target: !input lights

mode: restart
